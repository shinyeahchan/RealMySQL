# [ 4. 아키텍쳐 ]
## ★ MySQL 서버 전체 구조 ★
![image](https://github.com/shinyeahchan/RealMySQL/assets/93124649/8aa31368-28a9-4e3a-bfa4-2346e04b8347)
---

- MySQL 서버는 MySQL엔진(머리 역할)과 스토리지 엔진(손발 역할)으로 나누어 진다.
  - MySQL엔진은 '핸들러 API'를 이용해 스토리지 엔진에 쓰기, 읽기 요청을 하고 데이터를 주고 받는다.

- MySQL 서버는 스레드 기반으로 작동하며 포그라운드 스레드, 백그라운드 스레드로 구분된다.
  - 포그라운드 스레드(=사용자 스레드) : 접속된 클라이언트 수 만큼 존재, 쿼리 문장 처리 역할, 커넥션 종료시 스레드 캐시로 복귀
  - 백그라운드 스레드 : InnoDB의 경우 해당, 로그 스레드와 쓰기 스레드 등이 해당
    - 사용자의 요청 처리 중에 쓰기 작업은 지연(버퍼링) 처리 가능, 읽기는 지연 처리 불가능
    - InnoDB 또한 일반 사용DBMS 처럼 쓰기 작업을 버퍼링해서 일괄 처리
    
- MySQL은 플러그인 모델 이다.
  - 부가적인 기능을 플러그인 형태로 다운로드해서 사용 가능하다.
  - 대표적으로 사용자 인증 관련 플러그인(캐싱SHA2인증 등)가 플러그인으로 구현 제공 된다.
---
## ★ 쿼리가 실행되는 과정 ★
![image](https://github.com/shinyeahchan/RealMySQL/assets/93124649/5fae7028-3a01-4077-b47b-b2c73b2b1185)
1. (MySQL엔진) '쿼리 파서' : 들어온 쿼리를 MySQL이 인식할 수 있는 최소한의 형태(토큰)로 분리하여, 트리 형태 구조로 만들어낸다. 이때 기본 문법 오류 검사도 진행된다.
2. (MySQL엔진) '전처리기' : 앞에서 만들어진 파서 트리를 기반으로 구조적 문제점을 확인한다. (테이블 이름, 컬럼 이름 등 유효성, 접근 권한 등)
3. (MySQL엔진) '옵티마이저' : 가장 효율적으로 처리할 수 있는 방법을 찾아 계획을 수립한다. (두뇌 역할)
4. (MySQL엔진) '실행 엔진' : 각 핸들러(스토리지 엔진)에 요청하고 결과를 사용자에게 전달한다.
5. (스토리지 엔진) '핸들러' : 들어온 요청에 따라 실제 디스크에 쓰기, 읽기를 진행한다.
   
##### 참고 ) 원래 제일 먼저 '쿼리 캐시'에서 동일SQL문의 결과를 즉시 반환하는 역할을 진행했으나, 동시 처리 성능 저하 문제로 8.0버전 부터는 제거 되었다.

---
## InnoDB 스토리지 엔진
![image](https://github.com/shinyeahchan/RealMySQL/assets/93124649/925cbcfb-8f7e-4b98-b903-e6893064859e)
- 거의 유일하게 레코드 기반의 잠금을 제공하는 스토리지 엔진으로 높은 동시성 처리가 가능하고, 안정적이고 성능이 뛰어나다.

- InnoDB 특징1) 프라이머리 키에 의한 클러스터링
  - 모든 테이블은 프라이머리 키 값 순서대로 디스크에 저장된다.
  - 모든 세컨더리 인덱스는 레코드 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용된다.
  - 프라이머리 키를 이용한 레인지 스캔이 상당이 빠르므로, 쿼리 실행 계획시 다른 보조 인덱스 보다 비중이 높게 설정된다.

- InnoDB 특징2) 외래키 지원
  - InnoDB 스토리지 엔진은 외래키를 지원한다.
  - 서비스용 DB에서는 외래키 사용안하는 경우도 많다. 왜냐하면 부모와 자식 테이블 모두 해당 컬럼에 인덱스 생성이 필요하고, 변경 시 잠금이 여러 테이블로 전파되어 데드락이 발생할 확률이 높아지기 때문이다.

- InnoDB 특징3) MVCC(Multi Version Concurrency Control)
  - 목적 : 잠금을 사용하지 않는 일관된 읽기 제공 (InnoDB는 언두 로그를 이용해 MVCC 기능을 구현)
  - 격리 수준이 READ_UNCOMMITTED의 경우 : InnoDB 버퍼 풀이 현재 가지고 있는 데이터를 반환한다. 즉, 커밋됐든 아니든 변경된 상태의 데이터를 반환하게 된다.
  - 격리 수준이 READ_COMMITTED 이상일 경우 : 커밋 전이라면, 변경되지 이전의 내용을 보관하고 있는 언두 영역의 데이터를 반환한다.
  - 이렇게 여러 버전이 동시에 유지되고, 상황에 따라 어느 데이터가 보여지는지 다르다. 이게 바로 MVCC
![image](https://github.com/shinyeahchan/RealMySQL/assets/93124649/b35e6aa9-2253-42cf-88fd-8569cca9b64c)

- InnoDB 특징4) 잠금 없는 일관된 읽기
  - MVCC을 이용해 잠금을 걸지 않고 읽기 작업을 수행한다.
  - 순수 읽기(SELECT)시 SERIALIZABLE이 아닌 다른 격리 수준에서는 다른 트랜잭션의 잠금을 기다리지 않고, 바로 실행된다.

- InnoDB 특징5) 자동 데드락 감지
  - 잠금 대기 목록을 그래프 형태로 관리.
  - 잠금이 교착 상태인지 주기적으로 체크하여, 교착 상태에 빠진 트랜잭션 중 하나를 강제 종료한다.
  - 트랜잭션의의 언두 로그 양이 가장 적은 것이 롤백 대상이 된다.
 
- InnoDB 특징6) InnoDB 버퍼 풀
  - 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간이다.
  - 쓰기 작업을 지연 시켜 일괄 작업으로 처리해줄 수 있게 하는 버퍼 역할도 한다.

- 그 외 특징 요약 생략

---
## MySQL 로그 파일
- 에러 로그 파일
  - MySQL이 실행되는 도중 발생하는 에러나 경고 메시지가 출력되는 로그 파일
  - MySQL 설정 파일(my.cnf)에서 log_error라는 이름의 파라미터로 정의된 경로에 생성

- 제네럴 쿼리 로그 파일
  - MySQL 서버에서 실행되는 쿼리 전체 목록
  - 에러 발생해도 일단 로그 파일에 기록된다.
 
- 슬로우 쿼리 로그
  - ong_query_time 시스템 변수에 설정한 시간 이상이 소요된 쿼리가 모두 기록
  - 정상적으로 실행 완료된 쿼리만 기록 가능하다.
